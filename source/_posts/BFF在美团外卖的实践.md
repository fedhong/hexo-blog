---
title: BFF在美团外卖的实践
date: 2018-04-22 13:36:46
tags: [BFF,前端]
categories: [前端]
---

#### BFF（Backend For Frontend），即提供给前端的后端应用。
什么叫提供给前端的后端应用呢？这与后端服务有什么区别呢？首先来看一看BFF的应用背景。

#### BFF的应用背景
提到BFF，还要从前后分离说起。随着互联网行业的不断发展，不同技术领域的术业专攻，产品迭代节奏的不断加快，对于开发效率的要求也越来越高。于是，并行开发，前后分离的开发模式，成为前后端同学备受欢迎的合作方式。后端同学不用关心页面如何呈现、如何渲染、如何提高页面打开速度等等，只需要知道页面需要展现哪些数据，通过接口，以JSON的格式返回即可。从而可以把更多的精力放到后端服务的深入研究与探索上。前端同学呢？不用关心数据如何存储、如何保障消息队列的完整性、如何设计分布式架构等等，可以更好的把精力放到用户交互体验、前端工程化上面。因此，前后分离，可以让同学们把有限的精力，分配在专业的领域上。同时前后端并行开发，互不阻塞，提高了一定的开发效率。那么前后分离之后，BFF的概念是如何被提出的呢？接下来看看常见的BFF职责。

#### 常见的BFF设计
在后端微服务的概念提出后，后端服务进行拆分。导致一个页面，可能需要请求多个后端服务，发送多个HTTP请求。同时，也很容易出现跨域的情况，虽然现在通过CORS，或者代理很容易解决跨域问题。这种架构还有几个明显的问题：页面首屏显示会比较慢，因为浏览器需要加载好html后，在额外发起ajax请求数据，进行渲染；此外，搜索引擎对JS异步加载渲染的数据抓取的效果也不好，导致这样的页面SEO会存在一定的问题；还有一点，如果前端服务只是类似nginx这样的静态服务，那在打开页面的时候，是无法做一些业务校验的，比如用户是否登录、是否有权限查看该页面，这些控制都要html请求完，打开页面以后，通过ajax再次发请求去校验，体验十分不好。

因此简单的前后分离以后，可能会存在以下几个问题：

* http请求较多
* 跨域问题
* 首屏渲染 & SEO
* 页面的访问控制

如下图，简单的前后分离架构：
{% asset_img 01.png 在没有BFF中间层之前%}

由此，前端同学想了一个办法解决这些问题，Any problem in computer science can be solved with another level of indirection，就是在浏览器与java服务之间，添加一层BFF。添加BFF中间层之后，我们可以在BFF这层做很多事情：
* 多接口合并请求，减少http请求数
* 接口代理，解决跨域问题
* 服务端渲染，更好的支持SEO
* 添加页面访问控制校验，登录状态、权限拦截等

如下图，添加BFF之后的架构：
{% asset_img 02.png 添加BFF中间层之后%}

#### 我们的BFF设计

实际上，BFF的使用现在很常见。基本都是前端同学通过Node搭建一个服务，提供给前端自己来使用。Node层实现了静态服务、访问控制，接口代理，请求合并，以及后端渲染等等。

那么我们的BFF与常见的BFF有什么区别呢？这就要从我们自身业务进行分析。由于我们组负责的业务线比较多，前端项目几十个。如果按照常规设计，每个项目起一个Node服务的话，就需要几十个Node。况且每个项目又分为dev、test、beta、stage、prod 5个环境。只是申请服务器，部署环境，维护node服务的成本，就已经很高了。而且同学们在写前端业务代码的同时，还要写node的controller层。实际上给前端同学带来了更多的工作量。这样的话会存在以下几个问题：
* 服务器重复申请、部署
* 访问控制（登录、权限）重复实现
* Node的多点维护
* 增加FE开发成本
* 服务稳定性保障是痛点

于是我们思考，可不可以提供一个公共的BFF，给所有前端项目来使用呢？答案是肯定的。如下图，
{% asset_img 03.png %}
我们设计公共的BFF，实现如下功能：
* 静态服务，HTML托管
* 接口反向代理
* 访问控制（单点登录、权限拦截）
* 多项目支持，公共的BFF
* 更好的服务保障

暂时未提供的功能
* 服务端渲染
* 多请求合并

由于我们的业务对SEO没有什么要求，至于首屏直出也不是很在意，所以服务端渲染这块并没有实现。多请求合并已经在设计中，很快会提供支持。

那么我们这样设计以后，收益还是比较明显的：
* 节省了大量服务器资源
* 前端同学专注业务
* 统一了流量入口，更有利数据分析
* 单点维护Node，服务的监控和预警统一
* 域名收敛，https化，防劫持

#### 总结
每个公司，每个团队，所面对的业务、环境都不一样，没有标准的设计，只有更适合自己的设计。